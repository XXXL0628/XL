# NF

#### NF基础

##### 防火墙概述

防火墙是设置在不同网络或网络安全域之间的一系列的组合。它是不同网络或网络安全域之间信息的唯一出入口。

![image-20200721091254122](E:\Typora\Image\image-20200721091254122.png)

##### 防火墙的发展历程

防火墙类型：

- 包过滤类防火墙
- 代理类防火墙（应用层网关防火墙）

![image-20200721091459909](E:\Typora\Image\image-20200721091459909.png)

UTM

Unified Threat Management  统一威胁管理

- 隔离不同的网络安全域
- ACL访问控制
- NAT（网络地址转换）
- 带宽管理
- 病毒防御
- 内容过滤
- 反垃圾邮件
- 恶意代码过滤
- VPN

2004年9月IDC首次提出UTM概念

UTM性能不足

![image-20200721091826725](E:\Typora\Image\image-20200721091826725.png)

Gartner定义下一代防火墙

![image-20200721092602598](E:\Typora\Image\image-20200721092602598.png)

第二代防火墙

公安部于2014年7月24日推出了《信息安全技术 第二代防火墙安全技术要求》

#### 网络基础知识及NF功能介绍

##### 型号划分

![image-20200721092813679](E:\Typora\Image\image-20200721092813679.png)

NF外观---前面板

![image-20200721092853885](E:\Typora\Image\image-20200721092853885.png)

后面板

![image-20200721092956291](E:\Typora\Image\image-20200721092956291.png)

##### Web登录

登陆工具

浏览器   https://设备的管理IP地址

![image-20200721093207410](E:\Typora\Image\image-20200721093207410.png)

M口默认地址：192.168.1.1

H口默认地址：192.168.2.1（可做管理口和心跳口）

##### 串口登录

###### 准备工作

- 工作计算机1台
- 随机附带的串口线1根
- 能够连接串口的终端软件（比如Windows自带的超级终端软件或putty、SecureCRI等)
- 用串口线将NF和工作计算机连接

###### 登陆工具

- secureCRT
- Putty
- 波特率设为115200

默认用户名：conadmin

默认密码：conadmin

###### 常用的串口操作

- 查看接口IP地址
- 设置M和H口地址
- 查看硬件特征值
- 修改系统时间
- 重置web用户名和密码
- 清空临时文件
- 初始化配置——分丢失证书、不丢失证书两种，清空配置，版本号不会变，
- 恢复系统——相当于重装系统，会将版本恢复到当前的固件版本，不丢证书

##### SSH登录

登陆工具

SSH2：50022端口

![image-20200721093804292](E:\Typora\Image\image-20200721093804292.png)

一次性密码有效期为一天

后台登陆：

- 一般是开发调试设备问题
- 不将一次性密码发给客户
- 登陆操作结束，及时退出SSH

#### NF软件架构

数通引擎（server）、安全引擎（class）

![image-20200721094100194](E:\Typora\Image\image-20200721094100194.png)

数据通信过程

![image-20200721094154687](E:\Typora\Image\image-20200721094154687.png)

![image-20200721094818516](E:\Typora\Image\image-20200721094818516.png)

###### 功能预览：

![image-20200721094933564](E:\Typora\Image\image-20200721094933564.png)

路由

路由——工作在网络层，是指NF从一个接口上收到数据包，根据数据包的目的地址进行定向并转发到另—个接口的过程。

数通引擎根据收到数据包中的iP地址以及路由表决定输出接口以及下一跳地址，并且重写MAC地址，实现转发数据包。

NF包含的路由功能

- 策略路由
- 直连路由
- 静态路由
- 动态路由：OSPF、BGP、IP
- 反向路由----从哪个接口进来就从哪个接口出去（仅支持TCP、UDP）
- ISP路由：中国电信、中国教育网、中国联通、中国移动

**路由的优先级**

**反向路由>策略路由>直连路由>动态路由&静态路由（ISP路由）**

静态管理距离AD和度量值metric

AD越小，优先级越大

metric是两条等AD的路由间的流量比，metric越小，越优先

#### NAT

- ###### SNAT（源NAT）

    - 原理
        - 将源IP（私网IP）修改成公网IP
        - 多对一
    - 作用
        - 缓解IP地址匮乏
        - 安全---屏蔽私网IP
    - 配置：【策略】->【NAT】->【源NAT】

![image-20200721101735556](E:\Typora\Image\image-20200721101735556.png)

- ##### DNAT（目的NAT）

    - 原理
        - 将内部服务器IP地址映射到公网地址
        - 多对一（映射部分端口）
        - 一对一（映射所有端口）
    - 作用
        - 隐藏内部服务器
        - 缓解IP地址资源匮乏
    - 配置：【策略】->【NAT】->【目的NAT】

![image-20200721103849637](E:\Typora\Image\image-20200721103849637.png)

![image-20200721104049205](E:\Typora\Image\image-20200721104049205.png) 

#### 一体化安全

安全策略---基本配置

- 控制元素
- 源、目的安全区
- 源地址对象、用户、目的地址对象
- 应用、应用过滤器、应用组、服务
- 时间
- 动作

安全策略---安全模板

入侵防护、url过滤、内容过滤、防病毒、无线管理

策略执行优先级：按网络层次进行解析并匹配。无确定的模块优先级

应用、应用过滤器、应用组、服务的关系

- 应用和应用过滤器、应用组是【或】
- 应用和服务是【与】
- 应用过滤器和服务是【与】
- 应用组和服务是【与】

防火墙日志中的特殊应用名称

- TCP不完整会话：表示会话没有完全建立，对TCP来说没有完成三次握手
- TCP、UDP不完整数据：表示该会话应用不能被完全识别

防火墙日志会通过FTP的方式传输给ESPC

安全策略日志通过A接口传输

![image-20200721105316726](E:\Typora\Image\image-20200721105316726.png)

DoS防护

- 基于统计分析
- 工作在数通引擎（server）上，关闭应用层防护后依然可以防护
- 相关日志在IPS日志区域查询、

流量管理

- 一定要配置源地址对象，否则没有精确的流量控制或者分析结果
- 流量分析基于应用或者服务：应用特征或服务端口

#### PPPoE

- client/Server 模型
- PPPoE Client向PPPoE Server发起连接请求，两者之间会话协商通过之后，PPPoE Server向PPPoE Client提供接入控制、认证等功能

NF的PPPoE部署

- NF目前只支持PPPoE Client功能，不支持PPPOE Server
- 通过拨号、做SNAT为下端用户上网

![image-20200721110428019](E:\Typora\Image\image-20200721110428019.png)

##### 资产识别说明

资产识别意义

针对内网活动Ip，根据其发出的网络流量，识别其操作系统、浏览器、杀毒软件、应用等，并根据资产属性的安全等级定义，针对性对高风险资产进行访问控制以及流量控制。

达到两个终极目标

1. 资产监控
2. 资产管理

##### 无线管理

无线资产分为两类

![image-20200721110731062](E:\Typora\Image\image-20200721110731062.png)

#### NF数据处理流程

数据包通过流程

![image-20200721110825354](E:\Typora\Image\image-20200721110825354.png)

#### 常见部署场景

- 虚拟线部署
- 边界网关部署
- 三层主备HA部署
- SSL VPN G-C部署

###### 虚拟线部署（基本不改变用户网络）

![image-20200721112028339](E:\Typora\Image\image-20200721112028339.png)

![image-20200721112049672](E:\Typora\Image\image-20200721112049672.png)

配置思路

- 配置网络——编辑接口

- 配置网络——新建虚拟线

    接口链路状态同步：一个接口down另一个接口也down

- 配置对象——新建IP池对象配置允许访问外网的用户网段

- 配置对象——新建安全模板，配置允许访问及不允许访问的URL

- 配置安全策略

注意事项

1. 编辑两个物理接口为Vwire后，还需要在网络----虚拟线中新建“虚拟线”
2. 新建虚拟线时“接口链路状态同步”代表，一个接口down后另一个接口也会down(电口模块除外);

###### 边界网关部署

属于网络环境中的重要组成部分，作为一个边界设备实现路由转发、地址缓缓等功能

配置思路

- 配置安全区--使用默认的安全区
- 配置接口
- 配置路由
- 配置网络对象以及NAT策略
    - 配置源NAT策略
    - 配置目的NAT策略
- 配置安全模板以及安全策略

![image-20200721115327883](E:\Typora\Image\image-20200721115327883.png)

#### 常见问题处理

专业参数：

- Default:上架设备使用
- Signature:功能测试使用
- Performance:性能测试使用

原则上，NF默认放行所有流量，如果想改变默认放行的设置，在专业参数中修改【ngfw_default_deny】

###### 重启引擎和应用配置

需要重启引擎的操作：

恢复引擎参数文件、恢复全部配置文件、自定义应用的新建/编辑/删除

###### 证书：

免费:防火墙、NAT、应用管理、流量管理、IPSEC VPN、用户认证、DOS防护

收费:一体化安全策略、SSLVPN(新导入SSLVPN证书需要重启)

证书过期的影响

试用证书：

- 引擎正常运行，不会对网络造成影响
- 可以记录和传输日志
- 无法登陆WEB管理界面进行管理和策略配置，访问https://设备IP时，页面提示需要导入证书
- 无法进行任何升级

正式销售证书

- 引擎正常运行，不会对网络造成影响
- 可以记录和传输日志
- 可以修改策略和接口配置
- 无法进行任何升级

###### 升级路线

![image-20200721152840250](E:\Typora\Image\image-20200721152840250.png)

升级注意事项

- Web界面升级，固件版本可能发生变化
- 版本回退:串口或“关于”查看固件版本，恢复系统至此固件版本
- NX3G2000L/G2100L/G200OM/G210OM型号设备升级前，建议关闭应用层防护，升级结束后再开启，升级完成后不影响安全功能的使用。

备份恢复

![image-20200721154417436](E:\Typora\Image\image-20200721154417436.png)

防火墙常见问题

![image-20200721154503587](E:\Typora\Image\image-20200721154503587.png)

运行日志要和系统审计（操作日志）区分开！



## NF_HA

#### HA概述

HA：High Availability  高可用性

广义:通常用来描述一个系统经过专门的设计，从而减少停工时间，而保持其服务的高度可用性。

狭义:是指通过配置两台设备的高可用性功能，当一台设备出现故障时，另一台设备可以继续**保持网络不间断的通信**，尽量缩短因日常维护操作（计划）和突发的系统崩溃（非计划）所导致的停机时间，以提高系统和应用的可用性。

组网拓扑

![image-20200721155229067](E:\Typora\Image\image-20200721155229067.png)

![image-20200721155240056](E:\Typora\Image\image-20200721155240056.png)

##### HA术语

###### 主主模式

- **两台设备均为主设备，都处理业务流量，同时又作为另一台设备的备份设备，备份对端的会话信息和配置文件**。当其中一台故障后，另一台设备负责处理全部业务，从而保证新发起的会话能正常建立，当前正在进行的会话也不会中断

###### 主备模式

- **两台设备，其中一台作为主设备，另一台作为备份设备。主设备处理所有业务，并将产生的会话信息和配置发送到备份设备进行备份;备份设备不处理业务，只用做备份。**当主设备故障，备份设备接替主设备处理业务，从而保证新发起的会话能正常建立，当前正在进行的会话也不会中断

###### 抢占模式

- 抢占模式下，主机down掉后，链路会切换到从机，在**主机恢复正常后，将会抢占从机流量**，此时主机切换到激活状态，而从机切换到非激活状态

###### 非抢占模式

- 非抢占模式下，主机down掉后，链路会切换到从机，在**主机恢复正常后，不会抢占从机流量**，从机仍处于激活状态，主机则处于非激活状态，直到从机down掉后，主机才会接管流量

#### HA实现方式

NF中HA实现方式

- 虚拟线
- 二层
- VRRP(Virtual Router Redundancy Protocol，虚拟路由冗余协议)（三层）∶是一种容错协议，它通过把几台路由设备联合组成一台虚拟的路由设备，并通过一定的机制来保证当主机的下一跳设备出现故障时，可以及时将业务切换到其它设备，从而保持通讯的连续性和可靠性。

虚拟线支持方式：

![image-20200721160024406](E:\Typora\Image\image-20200721160024406.png)

VRRP

![image-20200721160215332](E:\Typora\Image\image-20200721160215332.png)

相关术语

- VRID:组ID，标识对等的一组端口
- VIP:虚拟路由器的IP
- 优先级:数字越大优先级越高，范围1-254
- Master:激活状态，发送免费ARP实际转发数据包的路由器
- Backup:处于监听状态的路由器
- VRRP控制报文:VRRP通告(advertisement）使用IP多播数据包进行封装地址是224.0.0.18 ，发布范围只限于同一局域网内，IP包的协议号为112，IP包的TTL值必须为255

注:只有一种报文类型–VRRP通告，只有Master才能发送VRRP通告

VRRP支持方式

![image-20200721160459725](E:\Typora\Image\image-20200721160459725.png)

部署方式

![image-20200721160804711](E:\Typora\Image\image-20200721160804711.png)

NF配置-虚拟线HA

主备拓扑

![image-20200721161701029](E:\Typora\Image\image-20200721161701029.png)

主备配置步骤

主机

- 配置接口
- 配置虚拟线
- HA基本配置
- HA虚拟线配置

备机

- 配置接口
- 配置虚拟线
- HA基本配置
- HA虚拟线配置

NF配置--VRRP配置

![image-20200721162120900](E:\Typora\Image\image-20200721162120900.png)

配置步骤

主机

- 配置接口
- 配置路由
- 配置NAT
- 配置安全策略
- HA基本配置
- 虚拟路由冗余配置

备机

- 配置接口
- 配置路由
- 配置NAT
- 配置防火墙策略
- HA基本配置
- 虚拟路由冗余配置

###### NAT绑定HA线路

HA场景下，NAT必须配置“HA线路“

###### 同步配置

- 对端>>本地:将对端设备的配置同步到本地，并应用配置
- 本地>>对端:将本地设备的配置同步到对端，并应用配置
- 针对【策略】和【对象】模块进行同步:
    - 包括：安全策略、NAT、用户认证策略、流量管理策略、各类对象、资产、IPmac绑定、链路探测、ISP信息以及ISP路由、VPN（SSL/IPSEC相关的配置）、（6.0.3.19开始包含：非对称路由配置）
    - 不包括：设备的接口类型、路由(除ISP路由)、高可用性的配置、专业参数config文件.

###### 其他

两台NF做HA的必备条件:

- 相同的型号
- 相同引擎版本
- 硬件接口完全一样多

每种HA，备机的物理接口状态:

- 三层的HA，备机的物理接口是up的
- 二层的HA，备机的物理接口是up的
- 虚拟线HA，备机的物理接口是down的。



## NF_VPN

VPN--Virtual Private Network

常见的VPN

![image-20200721164317673](E:\Typora\Image\image-20200721164317673.png)

NF主要支持：L2TP、IPSEC、SSL、GRE



### IPSEC VPN

IPsec（IP Security）

- 是一系列基于IP网络的由IETF正式定制的开放性IP安全标准，是虚拟专用网的基础，已经相当成熟可靠
- 对所有IP级的通信进行加密和认证：使用IPsec可以确保包括远程登陆、客户/服务器、电子邮件、文件传输、Web浏览、ERP、视频会议、IP电话等在内的各种应用程序的安全

简化VPN环境下的拓扑

![image-20200721164807724](E:\Typora\Image\image-20200721164807724.png)

IPSEC VPN过程

- 隧道协商
    - IKE协商（2个阶段）
- 数据交互

NF IPSEC VPN支持的部署方式

- G-G：直接访问内网资源
- G-C：安装客户端



IKE协商阶段

第一阶段

- 在隧道两端之间**创建安全通道**，使后面的第愈阶段协商受到安全保护，并进行**身份验证**。
- 两种模式:**主模式**和野蛮模式。

第二阶段

- **协商IPSEC SA使用的安全参数**，创建IPSEC SA，使用AH或ESP来加密IP数据流。
- 模式:**快速模式**。

第一阶段主模式

![image-20200721165446191](E:\Typora\Image\image-20200721165446191.png)

第二阶段

![image-20200721165658198](E:\Typora\Image\image-20200721165658198.png)

**协商阶段采用UDP协议，端口500；网络中存在NAT的情况下，端口4500**



 IPSEC VPN网关-网关的配置步骤

![image-20200721170441926](E:\Typora\Image\image-20200721170441926.png)

通过配置两台NF，实现以下需求：

1. 两台NF以网关到网关的方式建立IPsecVPN连接
2. 客户端NF的内网用户可以通过网关到网关的IPsec VPN访问服务器NF的内网Web服务

NF Server配置：

- 新建IPSEC VPN安全区
- 新建IPSEC VPN接口
- 配置安全策略
- 新建服务器端VPN隧道

NF Client配置

- 新建IPsec VPN 安全区
- 新建IPSEC VPN接口
- 配置安全策略
- 导入客户端配置



### SSL VPN

![image-20200721171120213](E:\Typora\Image\image-20200721171120213.png)

SSL VPN过程

- TCP三次握手
- SSL握手
- 数据交互

NF SSL VPN支持的部署方式

- G-G：直接访问内网资源
- G-C：
    - WEB转发：https://IP/sslvpn
    - L3VPN：https://IP/sslvpn安装插件或者.exe客户端



SSL握手

![image-20200721171404924](E:\Typora\Image\image-20200721171404924.png)

NF支持SSL VPN的方式

- WEB转发（http、https、ftp、mail）
- L3VPN

SSL

![image-20200721171701712](E:\Typora\Image\image-20200721171701712.png)

通过配置NF，实现以下需求:

1、远程用户与NF以远程用户到网关的方式建立SSL VPN连接。
2、NF对远程用户进行接入认证，根据权限设置授权远程用户访问内网Web服务。

配置过程：

- 添加VPN用户;
- 新建SSL VPN安全区;
- 新建SSL VPN接口;
- 配置VPN基本信息
- 新建VPN链路;
- 配置VPN可访问的资源;
- 配置VPN授权访问;
- 配置SSL VPN到Intranet的允许安全策略。



##### 常见问题排查

SSL VPN资源状态异常

VPN资源状态显示为[资源正常，VPN访问被阻止，请检查配置]，是由于VPN接口地址与VPN资源之间网络不可达，而NF内网口与VPN资源是网络可达的。解决方案是保证内网资源有到达VPN接口地址的路由，或者在NF内网口配置SNAT策略。

常见问题排查思路

![image-20200721172354794](E:\Typora\Image\image-20200721172354794.png)
# ESPCv7

ESPC存在ESPCv6和ESPCv7两个版本，ESPCv6适用于windows版本，v7适用于Linux版本，但是公司已经对v6版本停止维护了

简介：绿盟企业安全中心 v7.0（NSFOCUS ESPC）是一款Linux产品，它是绿盟科技安全产品统一管理平台

功能：设备管理、日志报表、策略管理、资产管理、用户管理、系统管理、级联功能等

**v7的提升：**

提升设备监管能力

- 全面监控设备的可用性和有效性
- 统—配置设备基础信息
- 全局策略统—设定

提升资产管理能力

- 个性化的资产标签
- 资产批量导入/批量删除
- 资产权重定义和多视图展示

提升用户权限管理能力

- 五种用户角色可供选择
- 界面级角色权限控制

丰富的业务功能开发接口

- 标准数据开发接口
- 数据处理性能的扩展

v7.0功能模块介绍

![image-20200722153420074](E:\Typora\Image\image-20200722153420074.png)

数据处理流程

![image-20200722153443787](E:\Typora\Image\image-20200722153443787.png)

ESPC v7.0安装部署与卸载

版本介绍

![image-20200722154032145](E:\Typora\Image\image-20200722154032145.png)

支持操作系统

- CentOS6.5x86_64
- Redhat6.5x86_64

支持浏览器

最新版本的Chrome、最新版本的firefox、IExplore 11

支持联动设备

![image-20200722154302788](E:\Typora\Image\image-20200722154302788.png)

![image-20200722154504278](E:\Typora\Image\image-20200722154504278.png)

安装部署流程

![image-20200722154520044](E:\Typora\Image\image-20200722154520044.png)

ESPC v7.0主机配置要求

![image-20200722154606104](E:\Typora\Image\image-20200722154606104.png)

主机准备

![image-20200722154620284](E:\Typora\Image\image-20200722154620284.png)

ESPC v7使用端口

![image-20200722154837328](E:\Typora\Image\image-20200722154837328.png)

![image-20200722154850467](E:\Typora\Image\image-20200722154850467.png)

**安装步骤：**

1. root账号登陆

2. 将光盘放入光驱

3. 获取光盘中数据和文件

4. 拷贝光盘中文件

5. 执行安装脚本

    安装过程中会显示安装进度，当进度达到100%时，表示安装完成

    默认安装目录为/opt/nsfocus，所以挂载磁盘需要挂载到/opt下或者根目录下

    安装完成后，ESPC会在操作系统中新建账号，用于部署ESPC使用

6. 配置时间同步（建议安装之前做这个操作）

    配置主机时区

    配置主机时间

    （可选）从NTP服务器同步时间，只适用于Redhat或CentOS操作系统

    手动配置时间

**单机部署：**

1. 打开浏览器，使用http://节点IP地址访问ESPC，弹出安全报警信息

2. 单击【继续浏览此网站】，接受加密通道，进入初始化页面

3. 单击【开始初始化】按钮，进入选择部署模式页面

4. 选择【单机模式】，单击【下一步】按钮，进入选择数据规模页面

    <1亿条/月：主机的配置小，数据推荐配置/最低配置，选择<1亿条/月

    ＞1亿条/月:主机的配置大，数据推荐最低配置选择＞1亿条/月

5. 选择【<1亿条/月】，单击【下一步】按钮，进入配置ESPC的入口IP地址（即安装ESPC的主机地址）页面

6. 配置节点的IP地址，单击【完成初始化】按钮，进入确认配置清单页面

7. 确认清单正确后，单击【应用配置】按钮，进入初始化即将完成页面

8. 登录ESPC

    默认用户名和密码是：admin/admin，初次登陆要求修改密码

9. 导入证书

大数据和小数据处理对比：

- 大数据处理模式︰设备的安全日志是存储HDFS，其它数据包括审计日志、用户信息和模块的运行数据仍然存诸在postgres中。
- 小数据处理模式∶所有数据存储在postgres中。

**集群部署**

前提：集群的所有节点都需要预先安装好ESPC

节点要求：

- 各个节点可以是物理机或虚拟机;
- 节点有虚拟机时，所有节点需要虚拟化系统—致;
- 所有节点需要运行到相同系列的操作系统，如全为centos或全为redhat.

实现功能：

- ESPC可处理的数据规模:>1亿条/月
- 数据处理和数据存储的分离
- 多个节点接收数据

集群部署步骤

1. 任意节点中打开浏览器，使用https://管理节点IP地址访问ESPC，弹出安全报警

2. 单击【继续浏览此网站】，接受加密通道，进入初始化页面

3. 单击【开始初始化】按钮，进入选择【集群部署】

4. 配置ESPC的入口IP地址（管理节点IP地址）页面

    该IP地址为管理入口的IP地址，用于管理ESPC、及安全设备注册

    ESPC可处理的数据规模：>1亿条/月

5. 单击【下一步】按钮，进入配置启用节点的服务页面

    数据接入：包括Kafka和南向接口，主要负责设备的接入和数据上传入口

    数据存储：存储设备上传的各种安全日志和设备审计日志，同时负责日志的查询及报表生成

    应用容器：负责APP的安装和运行维护

6. 页面下方文本框中，配置节点IP地址，单机【添加其他ESPC】按钮，添加其他节点。若有多个节点，需添加多次

7. 配置各节点
    可单机节点IP地址区域，重新配置IP地址，用于管理ESPC。
    配置节点主机名( hostname )
    启用节点服务

8. 单击【完成初始化】按钮，进入确认配置清单页面

9. 确认配置后，单击【应用配置】按钮，进入初始化即将完成页面

10. 完成初始化后，登录ESPC，导入证书，操作与单机部署相同

#### 卸载ESPCv7

方法一

1. 使用root账号登陆所有节点所在主机

2. 进入ESPC安装文件所在目录

    ![image-20200723093430932](E:\Typora\Image\image-20200723093430932.png)

3. 卸载ESPC

    ![image-20200723093447779](E:\Typora\Image\image-20200723093447779.png)

方法二

1. 使用root账号登录所有节点所在主机

2. 直接运行新的ESPC安装包，ESPC在安装时会首先检测系统中是否已经安装了ESPC，如果已有，则提示是否卸载已有ESPC

    ![image-20200723093859291](E:\Typora\Image\image-20200723093859291.png)

3. 此时输入Y并回车，则会调用ESPC的卸载脚本进行卸载

注意：使用安装包卸载，一定要保证使用的安装包版本大于等于安装环境的版本



注意事项

完成安装部署后的注意事项

- 不允许修改或删除节点上ESPC创建的帐号、密码及其目录
- 不允许自行修改节点的IP地址。若需要修改节点的IP地址，请联系绿盟科技的技术支持人员。
- 安装时新增内存和硬盘的检查，内存小于4G的不支持安装，硬盘检查的是/opt所在的挂载分区的可用空间，小于500G不支持安装。
- 安装完成后不可直接对磁盘进行挂载扩容，若有扩容需求，请重新卸载安装
- 安装完成后强烈不建议客户进行磁盘、服务器的迁移
- ESPC hash值与服务器CPU网卡信息相关，若更换了该硬件，需重新申请证书



#### ESPC设备管理

设备联动-

​	添加设备方法一

第一步：设备上添加ESPC的地址

适用于NIPS/NIDS V5.0R06F10、TACV2.0R01F00SP01等新A接口设备

![image-20200723094402413](E:\Typora\Image\image-20200723094402413.png)

点击确定生效

适用于NIPS/NIDS V5.6.7-5.6.9等老A接口设备

![image-20200723094439693](E:\Typora\Image\image-20200723094439693.png)

重启引擎生效

第二步：发现ESPC上注册成功



​	添加设备方法二

(适用于NIPS/NIDSV5.6ROOF01、TACV2.0R01F0OSPO1等)

第一步:设备上配置本地传输地址（这种方法只支持设备没有被ESPC管理)

适用于NIPS/NIDS V5.6ROOF01、TACV2.0RO1F0OSPO1等新A接口设备

第二步：ESPC上添加设备的地址，点击【注册】，过会注册成功，设备在线



设备列表

设备列表展示内容

- 最新：设备刚接入，执行修改设备基本信息，查看了证书信息、启用、禁用等操作后，“最新”标签消失
- 升级：升级包管理中下载了该设备可升级的升级包

![image-20200723100116130](E:\Typora\Image\image-20200723100116130.png)

配置设备

配置设备网络、路由、DNS等

设备拓扑----联动设备拓扑图

自动生成，无法编辑

设备历史状态查询

可以展示设备CPU状态历史趋势、内存状态历史趋势、磁盘状态历史趋势、CF卡状态历史趋势、流量状态历史趋势



全局策略-设备审核

设备审核：指当安全设备接入ESPC时，是需要用户手动审核，审核不通过的设备无法接入ESPC，不能接受ESPC的统一管理

![image-20200723100659496](E:\Typora\Image\image-20200723100659496.png)

![image-20200723100738776](E:\Typora\Image\image-20200723100738776.png)

配置备份设置（针对所有设备）

配置备份：默认开启备份，备份周期可选每天一次、每周一次、每月一次、每几天一次、每几月一次

备份路径：/opt/nsfocus/espc/ftp/device/backup/设备类型

当开启单机“配置备份”策略后，全局“配置备份”策略对该设备失效

策略管理

注意：V7.0R00F01及以上安装版本，自带IPS/IDS、SAS、NF的策略管理APP

通过升级包升级到V7.0R00F01版本，需要单独安装SAS、NF这两个APP（官网升级站点发布http://update.nsfocus.com/update/listEspc）

IPS/IDS策略管理

![image-20200723105316173](E:\Typora\Image\image-20200723105316173.png)

获取策略是将设备中已有的所有策略和对象全部上传到ESPC中，并覆盖系统中已经存在的策略和对象。

ESPC首次对某一设备进行管理时，系统中不存在该设备的任何对象信息和策略信息，此时必须对设备进行获取策略操作。

![image-20200723105516446](E:\Typora\Image\image-20200723105516446.png)

第二步：单击IPS/IDS设备名称，进入设备策略配置页面

第三步：单击【新建】按钮，弹出新建入侵防护策略对话框

第四步：单击【确定】按钮，新建策略成功

第五步：点击下发策略图标，进行策略下发

第六步：点击应用配置图标，使策略生效



SAS策略管理

支持策略获取、下发、导出、导入、应用配置功能

![image-20200723105828225](E:\Typora\Image\image-20200723105828225.png)

NF策略管理

支持策略获取、下发、导出、导入、应用配置功能

![image-20200723105932798](E:\Typora\Image\image-20200723105932798.png)

设备升级的方式

只检查不下载:检查到有新的升级包时，会通知用户。

检查并下载︰检查到有新的升级包时，会将升级包下载到ESPC服务器，并通知用户。

下载并升级︰检查到有新的升级包时，会将升级包下载到ESPC服务器，并自动升级安全设备。

手动升级

前提：设备管理-升级包管理已经下载了升级包

自动升级

第一步:选择下载并升级，升级包列表选择想要进行自动升级的升级包

第二步:ESPC V7.0到更新时间去外网升级站点更新升级包，会进行下载，下载的升级包可以在升级包管理看到。

第三步∶下载完后，会下发升级命令给设备，设备会从ESPC获取升级包并升级。



升级包管理

升级包列表，支持手动检查和手动上传

状态，“最新”表示最新获取的，“在线”表示自动获取的，“离线”表示手动上传的

ESPC V7.0升级路线和升级包获取

![image-20200723110250017](E:\Typora\Image\image-20200723110250017.png)

**ESPC手动升级**

手动（离线）升级是指手动至升级站点下载升级包至本地后，将升级包上传至ESPC进行升级。

1.选择菜单【系统管理】->【系统升级】>【手动升级】,单机【选择升级包】按钮，选择本地升级包

2．确认升级包信息是否正确。单机【取消】按钮，重新执行离线升级操作﹔单机【确认升级】按钮，开始升级。

成功：所有节点升级成功后，页面提示升级成功

失败：ESPC将恢复到升级前版本，可检查后重新升级



**在线升级**

自动升级

ESPC会自动在更新时间至升级站点检查是否存在升级包，若存在、则自动下载升级包并进行升级。

1.选择菜单【系统管理】->【系统升级】【在线升级】，【开启】自动升级，升级方式选择【检查并升级】。

半自动升级

ESPC会自动在更新时间至升级站点检查是否存在升级包，若存在、则将升级包信息记录至升级信息中并提示用户进行升级，用户可至升级信息列表中执行手动升级操作。

1.选择菜单【系统管理】->【系统升级】>【在线升级】，【开启】自动升级，升级方式选怎【检查更新】。

手动报表

- 支持IPS/IDS、SAS、NF、SAS-H、WAF 手动报表生成（报表模板内置，不支持自定义)
- 生成的报表在报表任务列表中查看和下载

周期报表

- 支持IPS/Ds、SAS、NF、SAS-H、WAF周期报表生成
- 周期报表每执行一次生成一个子任务，每次执行的报表结果在子任务列表中查看和下载

报表过滤

将常用报表内容过滤条件保存成过滤器，生成手动报表/周期报表时直接引用

备份恢复

数据管理-备份恢复

- 可备份/恢复ESPC的系统信息（资产信息、配置信息、信誉库等）和各类日志信息

大数据和小数据备份模式的差异∶

- 小数据模式备份:支持备份增量的数据日志及全量的系统信息
- 大数据模式备份∶支持备份增量的数据日志及全量的系统信息

单机部署和集群部署备份模式的差异:

- 单机部署︰支持本地备份
- 集群部署∶只支持ftp备份

备份的数据格式:

- 备份出的tar包以日期为标识
- 增量数据日志(21类）名称为∶日志类型
- 全量系统信息（5类）名称为∶日志类型

日志类型与备份文件对应关系

![image-20200723111055376](E:\Typora\Image\image-20200723111055376.png)

备份恢复-

​	自动备份

- 自动备份是增量备份，可以设置每天一次，每周一次，每月一次
- 备份路径，可填写操作系统其他存在并且具有读写权限的路径



​	立即备份

- 开始备份，有进度条显示



​	数据恢复

- 数据路径
    - 单机部署:ESPC所在主机上的已备份文件的存放路径
    - 集群部署:ESPC数据库所部署的主机上的已备份文件的存放路径，需要将之前备份的出的文件拷贝到数据库所部署的主机上
- 全量的系统信息，恢复时，与时间无关
- 增量的设备日志，恢复时，会恢复对应时间范围内的数据，注意选择恢复的时间范围。

超限管理-删除设备日志

- 设备日志删除方式∶手动删除和自动删除
- 大数据模式∶设备日志存储在HDFS中，删除的是HDFS的数据
- 小数据模式∶设备日志存储在PostgreSQL中，删除的是PostgreSQL中的数据
- 删除数据前检查是否已自动备份(**仅支持小数据模式**）∶检查的是本地备份路径，并且检查的是自动备份的路径，如果勾选，删除前，有相应数据备份，则删除，没有备份，则不删除
- 自动删除∶**默认情况下未开启**，点击“应用配置”则开启，每天凌晨1点1分执行

删除审计日志

- 审计日志包括:系统审计日志、设备审计日志、APP审计日志
- 大数据模式和小数据模式:审计日志都存储在PostgreSQL中
- 删除数据前进行备份检查∶检查的是本地备份路径，并且检查的是自动备份的路径，如果勾选，删除前，如果备份，则删除，没有备份，则不删除
- 自动删除︰**默认情况下未开启**，点击“应用配置”则开启，每天凌晨2点2分执行

磁盘告警设置

- 默认情况下未开启，开启后，大于等于“磁盘超限删除阈值”’，则进行日志删除
- 大数据模式∶设备日志存储在HDFS中，删除的是HDFS的数据
- 小数据模式:设备日志存储在PostgreSQL中，删除的是PostgreSQL中的数据

账号管理-账号列表

- 支持编辑、启/停用账号，默认auditor和sys是停用的
- 自定义账号支持导出导入功能
- 支持新建账号
- 如果已停用的账号，退出再登录时，会提示"账号已停用，请使用其他账号登录”。
- admin/security具有将账号停用/启用的权限。

如果admin不慎将自己停用，可以用security帐号对其启用

常见FAQ

**账号被锁，如何快速解锁**

- 系统默认30分钟内允许登录错误5次以内，>=5次锁定30分钟。
- 30分钟内连续错误不足5次，登录成功时，错误次数清零。
- 30分钟内连续错误超过5次，账号被锁定，不等30分钟解锁，如何解锁呢?

解锁

- 除admin外账号被锁: admin/security 帐号登录，进入用户管理-帐号管理-帐号列表，被锁定的帐号名上有个锁，点击即可解锁。
- admin账号被锁:security帐号登录对其解锁。方法同上。

**忘记admin密码，如何重置**

需通过工具重置admin账号密码(resetAdminPasswd.pyo )

将resetAdminPasswd.pyo上传到espc服务器

执行命令：python resetAdminPasswd.pyo

![image-20200723112920569](E:\Typora\Image\image-20200723112920569.png)

如上图，重置成功。重置后admin密码为admin

PS : wiki知识点12817附件下载工具。另重置后再次登录界面，会提示修改默认密码。需修改后重新登录

**如需改IP，如何操作**

注意，目前只支持单机部署环境修改IP

ESPC V7.OROOFO1之前版本∶修改方法参见wiki解决方案6004
ESPCV7.0ROOFO1之后版本∶修改方法参见wiki解决方案6004

![image-20200723113111795](E:\Typora\Image\image-20200723113111795.png)

PS∶尽量还是在—开始部署时规划好IP，修改IP的操作，有失败的可能性。

**开放端口**

配置ESPC网络防火墙端口时，防火墙规则如下表所示

![image-20200723113159935](E:\Typora\Image\image-20200723113159935.png)
# WAF

典型web应用架构图

![image-20200723114814927](E:\Typora\Image\image-20200723114814927.png)

HTTP请求

![image-20200723114917460](E:\Typora\Image\image-20200723114917460.png)

HTTP请求之首行

标记互联网资源：

URI：Universal Resource Identifier,通用资源标识符

![image-20200723115056987](E:\Typora\Image\image-20200723115056987.png)

HTTP请求之方法

- GET：获取URI的内容
- HEAD：只请求页面的首部
- POST：在Request-URI所标识的资源后附加新的数据
- DELETE：请求服务器删除Request-URI所标识的资源
- OPTION：查看web支持那些方法

Referer

![image-20200723134122821](E:\Typora\Image\image-20200723134122821.png)

 HTTP响应

![image-20200723134200340](E:\Typora\Image\image-20200723134200340.png)

常用返回码

- 200页面客户端请求已成功响应
- 301页面永久重定向某个链接
- 302页面临时重定向到粟个链接
- 400页面bad request method
- 403页面资源不可用，禁止访问
- 404页面访问的页面暂时不存在
- 500页面内部服务器错误

**HTTPS加密验证过程**

HTTP+SSL/TLS 端口443

![image-20200723134431267](E:\Typora\Image\image-20200723134431267.png)

## WAF部署

web安全风险

![image-20200723134747534](E:\Typora\Image\image-20200723134747534.png)

NSFOCUS Web Application Firewall
绿盟Web应用防火墙(Web应用防护系统），简称WAF，是绿盟科技面向企业、政府等各类机构推出的专注于保护Web应用和Web服务的安全产品。

![image-20200723134848339](E:\Typora\Image\image-20200723134848339.png)

WAF型号

![image-20200723134949553](E:\Typora\Image\image-20200723134949553.png)

性能相关指标:
cps:每秒新建TCP连接数
tps:每秒GET/POST请求报文数
引擎并发数:保持连接数
引擎流量(HTTP吞吐量):单位bps



设备外观

![image-20200723135215214](E:\Typora\Image\image-20200723135215214.png)

![image-20200723135359594](E:\Typora\Image\image-20200723135359594.png)

**WAF的H口不是心跳口，板槽一定是从低到高从左到右**

登录

用户名/密码：

- WEB管理员:admin/admin
- WEB审计员: auditor/auditor
- 维护账号:maintainer/maintainer
- 串口管理员:
- 6061版本及以后:nsadmin/nsadmin,
- 6061版本以前: conadmin/conadmin

部署上线流程

![image-20200723135746746](E:\Typora\Image\image-20200723135746746.png)

#### 串联部署：

![image-20200723135826989](E:\Typora\Image\image-20200723135826989.png)

应用场景：

- 不改动原有网络拓扑
- 不增加网络设备接口
- WAF关机不影响服务器访问
- 需要在server端管理

网络接口

创建工作组，选择bypass对接口

![image-20200723140136865](E:\Typora\Image\image-20200723140136865.png)

**WAN口接网络端，LAN口接服务器端，接反了没有防护效果**

带内管理/带外管理

默认防护站点/策略

防护站点：IP+端口

与客户确认信息：

- HTTP还是HTTPS: HTTP
- 服务器的IP和端口:192.168.0.6:80
- 对服务器熟悉程度:很熟悉，操作系统是Linux/Unix，WEB服务器是Nginx，数据库是Mysql，开发语言不限制。

虚拟站点

虚拟站点：域名

与客户确认信息：

- 防护的域名：cms.cmobile.net
- 检测的URI：/123/*
- 不检测的URI：/123/abc/*

上线前的注意事项

1、确认WAF的系统版本为最新，可以参考update.nsfocus.com中WAF的版本号

2、在无要求的情况下不建议开启ARP防护

3、配置完规则以后，先将动作设置为接受或开启一键接受、内置解码失败动作改为放过，开始策略优化流程

![image-20200723141305993](E:\Typora\Image\image-20200723141305993.png)

多路串联部署：选择正确的接口，创建多个工作组

#### 旁路部署

牵引：静态路由牵引（32位掩码最优）

回注：

- 二层回注
- 跨接回注
- PBR回注

![image-20200723141643110](E:\Typora\Image\image-20200723141643110.png)

注意事项

- 静态路由:用来指定HTTP协议流量从WAF的哪一个口回注到交换机上，进而达到客户端或者服务器，是对HTTP协议流量进行的回注牵引。
- 回注路由:用来指定非HTTP协议流量从WAF的那个端口回注到交换机，进而达到客户端或者服务器，是对非HTTP协议流量进行的回注牵引。
- 常见问题:WAF旁路部署时，无法访问被防护服务器的非HTTP服务。

正向代理

特点：隐藏客户端

![image-20200723142026383](E:\Typora\Image\image-20200723142026383.png)

反向代理：

特点：隐藏服务器

![image-20200723142046256](E:\Typora\Image\image-20200723142046256.png)

#### 反向代理部署

应用场景：不希望把WEB服务器暴露在公网

特点：

- 客户端与服务器互相均不可见
- 只转发代理策略匹配的HTTP流量
- 要更改DNS指向
- 客户端IP地址添加到请求的x-Forwarded-For域

![image-20200723142229590](E:\Typora\Image\image-20200723142229590.png)

反向代理只有防护模式、一定要配虚拟站点

访问网站

- 访问WAF的WAN口地址
- 服务器收到的源IP地址是WAF的WAN口地址
- WAF不修改HOST字段

#### 镜像监听部署

应用场景：

- 只需要检测是否被攻击
- 不需要防护

种类：

- 镜像LAN口的上、下行流量
- 镜像WAN口的上、下行流量
- 镜像LAN口的上行流量以及WAN口的下行流量

![image-20200723151323757](E:\Typora\Image\image-20200723151323757.png)

部署方式比较

![image-20200723151444295](E:\Typora\Image\image-20200723151444295.png)

HTTPS证书制作

去掉服务器私钥密码->将公钥、服务器CA证书和去掉密码的私钥合并->上传WAF

组成cer证书顺序：公钥->CA证书->私钥

有WAF的HTTP请求过程

![image-20200723152241578](E:\Typora\Image\image-20200723152241578.png)



## WAF防护

触发规则后的动作

![image-20200723152532507](E:\Typora\Image\image-20200723152532507.png)



全局防护

![image-20200723152722595](E:\Typora\Image\image-20200723152722595.png)

站点防护

策略匹配流程

![image-20200723153813833](E:\Typora\Image\image-20200723153813833.png)

站点防护分类

![image-20200723153932360](E:\Typora\Image\image-20200723153932360.png)

SSL加载/卸载应用场景

某网站服务器支持http/https，只想对部分关键页面（登陆，支付业务)强制客户端使用https访问，其他业务采用http访问

![image-20200723154058765](E:\Typora\Image\image-20200723154058765.png)

某银行网站一直采用对外面向客户使用https方式提供服务，而服务器只支持http访问方式:

![image-20200723154138710](E:\Typora\Image\image-20200723154138710.png)



WAF安全防护模块

协议校验：

- HTTP协议校验

基础防护

- HTTP访问控制
- Web服务器/插件防护
- 爬虫防护
- Web通用防护
- 文件非法上传防护
- 非法下载限制
- 信息泄露防护

高级防护

- 盗链防护
- 跨站请求伪造防护
- 扫描防护
- Cookie安全
- 内容过滤
- 敏感信息过滤
- 暴力破解防护



HTTP协议校验

作用:

- 防止服务器被畸形HTTP协议请求包请求导致异常

背景:

- Web应用都要严格按照HTTP协议进行数据交换，所以从客户端传输到服务器端的HTTP报文必须是符合协议规定

检测方法:

- 根据RFC规范，对所有的HTTP请求做检测(不针对某个具体的URL)
- 明显违背RFC规范的，无法被核心引擎理解的HTTP请求（内置规则)
- 能被核心引擎理解的HTTP请求，封装的信息不符合正常浏览器规范（界面可配置)

触发内置规则动作：

1、**串联、旁路部署**下，解码失败动作有2个选项：阻断、放过，默认是阻断

2、**反向代理**下，站点配置中无“解码失败动作”的配置，默认阻断

web服务器/插件防护

- Web服务器漏洞防护规则
- Web插件漏洞防护规则

HTTP访问控制

- 通过主机名、URI-Path、HTTP方法以及客户端IP等多个条件实现对HTTP请求的组合控制
- 举例：阻断192.168.10.10对www.test.com/abc.html的访问

非法上传的防护方法

- 检查上传文件扩展名：扩展名黑名单（补充）
- 检查上传的文件类型：文件扩展名+文件内容

信息泄露防护

- 修改响应报文中的服务器名
- 根据响应码阻断不正常请求
- 重定向至指定网页
- 伪装指定页面

盗链防护

某些无良服务提供商使用未经许可的超链接引用受害站点，引用的通常是受害者服务器的图片、音频等资源，由子从这些无良提供商过来的流量间接的到了受害站点，导致受害站点带宽负载过多，网站点击率却没有提高。

注:只针对图片、视频，音频等资源防护

- Referer防护算法

Referer检测

![image-20200723162241870](E:\Typora\Image\image-20200723162241870.png)

- Referer+Cookie防护算法

Referer+Cookie结合算法

![image-20200723163304272](E:\Typora\Image\image-20200723163304272.png)

Cookie安全

Cookie签名：

- 客户端需要使用Cookie
- 防止Cookie值被篡改

Cookie加密

- 需要保护Cookie中的敏感信息
- 客户端得到的Cookie值是加密后的密文

启用源IP校验

- 防止Cookie被盗用
- 签名或密钥与源IP无关



WAF的防护方向

请求：

- 利用目前的算法或者规则进行请求的防护，可以阻止扫描器和黑客的攻击
- 如果防护被绕过，还可以根据自定义的策略进行攻击的阻断。

响应：

- 对服务器的回应进行规则匹配或者算法检测。
- 有效控制了服务器的回应信息，减少信息泄露

请求方向防护

![image-20200723164723010](E:\Typora\Image\image-20200723164723010.png)

响应方向防护

![image-20200723164740490](E:\Typora\Image\image-20200723164740490.png)

WAF防护策略顺序

![image-20200723164757890](E:\Typora\Image\image-20200723164757890.png)

策略优化流程

站点、虚拟站点配置：选择服务器类型、模板->开启"一键接受"或所有策略动作选择“接受”，测试可以产生日志->收集2~5天日志，判断误报：添加例外或取消规则->恢复“阻断”或关闭“一键接受”

![image-20200723165258028](E:\Typora\Image\image-20200723165258028.png)



**优化步骤1**

正确选择服务器系统类型，中间件类型，数据库类型，使得WAF自动过滤不必要的规则，一方面减少误报，一方面节省WAF性能:

策略模板：三种模板，如果客户无特殊要求，选择default_medium

**优化步骤2**

所有策略选择为“接受”，尽量多地记录日志:

- —键接受，使得所有策略都变为接受动作（日志中记录还是阻断，但是实际动作为接受，便于筛选调优）
- 接受和放过的区别：
    - 接受:匹配到该策略中的规则告警后，继续自上而下匹配其他的策略;
    - 放过:匹配到该策略中的规则告警后，不再匹配其他的策略直接将该包发送给服务器;

验证设备可以产生曰志



一键接受

- 同时作用于站点组及虚拟站点
- 包括Web安全防护(内置HTTP协议核验除外）和数据安全传输
- 功能开启后，不论站点组及虚拟站点应用的策略动作为何，其防护检测状态都置为接受。

**优化步骤3**

- 获取足够多的日志（一般为2-5天)，查看其中动作为阻断的日志。
- 规则型防护策略优化建议
    - 根据告警中的关键字和匹配的规则信息进行分析，正常访问业务进行抓包做数据对比，最后跟客户确认调整方案。(比如是去掉规则还是添加例外)
- 算法型防护策略优化建议
    - 了解算法原理，基于算法流程优化。

**优化步骤4**
关闭“一键接受”



#### 日常维护和排错

升级一个包就要重启一次

V6.0R05平台升级路线

![image-20200723170722905](E:\Typora\Image\image-20200723170722905.png)

系统升级注意事项

1.系统升级包必须手动导入，不能自动在线升级;

2.除特殊说明外，系统升级完成后要重启设备，必须与客户沟通升级时间;

3.设备重启可能导致业务中断，串联模式建议使用bypass功能，其它模式建议下线；镜像模式无法升级，需要先切换到别的模式下;

4.系统升级包有依赖关系，请严格按照路线图升级;

5.遇到在升级线路中找不到的版本，很有可能是特殊版本，请先跟400进行确认;

6.升级前校验升级包的MD5值；

7.升级失败后，请在串口下还原系统，回退到固件版本;(镜像模式无法串口回退)

8.升级固件包过程中，界面提示成功前严禁设备重启、断电，否则只能串口回退或者返厂处理;

9.大版本升级前，必须仔细查看升级说明、提前备份配置。

规则升级配置：规则升级包为全量最新，每次只需我升级最新的升级包

规则升级

![image-20200723171401290](E:\Typora\Image\image-20200723171401290.png)

获取升级包

- 绿盟官网
    - 至绿盟科技官网-【客户支持】-【软件升级】栏目获取
- 通过FTP获取
    - 还未在官网发布的最新包、临时升级包（非标准升级包）、合并包、定制包
    - Release note
- 通过400产品支持部获取
    - 特殊包、定制包
    - 400-818-6868

联动ESPC

- 6060只能联动ESPCv7
- 要联动ESPCv6，下单前必须选择6060以前的版本
- 如果出厂镜像是6060，无法回退到以前版本，只能返厂

日志

**安全防护日志：**

1. 记录各类防护策略的日志
2. 只保留近7天

**运行日志：**

1. 记录设备的运行状态，包括接口up/down、引擎启停等；
2. 永久保留

**审计日志：**

1. Auditor账号查看
2. 登录日志、操作日志（包括配置策略、修改运行模式等）
3. 永久保留

**导出、删除：**

1. 分时、全部导出
2. 清空数据库：删除所有此类日志
3. 清除文件：清除界面上导出的日志数据包



证书

![image-20200723172917468](E:\Typora\Image\image-20200723172917468.png)

V6041版本之前的证书限制“防护路数”，V6041及后续版本去掉该限制



配置同步

系统管理->系统工具->配置同步

同步内容

- 整机同步:对设备上所有的配置文件进行备份，还原操作时直接覆盖被还原设备上的所有配置(不包括证书)
- 资产&策略同步:包含所有站点、站点组配置和所有策略的同步，实行覆盖操作
- 策略同步:选择同步策略种类，所有策略均追加至被同步设备（重名策略后面会添加_synced后缀），不会丢失任何原有数据。

同步方式

- 离线同步:每种同步内容最多创建5个还原点
- 在线同步:输入对端IP地址，接收端使用6060端口

配置同步

![image-20200723173257182](E:\Typora\Image\image-20200723173257182.png)



**BYPASS**

- 包转发
- Web界面内置bypass
- 串口开启bypass

内容编码/代理协议

![image-20200723173427405](E:\Typora\Image\image-20200723173427405.png)

部署模式

模式配置

- 转发模式:不做任何处理
- 工作模式:对客户连接做相应处理，是正常的工作状态
- 调试模式:引擎依然工作，引擎灯黄色，引擎会记录自身工作日志

紧急模式

- 直接转发新建的连接，对原有连接仍然由引擎处理



磁盘监控配置

- 作用:避免WAF设备日志量过大导致磁盘空间不足，从而引起设备故障的场景。
- 方法:达到普通告警阈值后，清空对应日志前提供是否备份操作;达到警戒阈值后，系统不进行备份，直接清空日志，释放磁盘空间。

代理信息配置

- 完全忽略:等同于关闭代理信息配置功能
- 记录代理信息:仅仅记录代理信息头部信息，即在相关日志中能看见相应字段后面的IP
- 策略中使用真实客户端IP:记录代理信息头部外，将解析得到的代理信息应用于策略中，如IP封禁等。

服务器存活判断

- TCP层探测
- HTTP层探测

没有防护效果的排查思路

![image-20200723174037475](E:\Typora\Image\image-20200723174037475.png)

![image-20200723174049148](E:\Typora\Image\image-20200723174049148.png)
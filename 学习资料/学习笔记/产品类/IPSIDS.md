# IPS/IDS

IPS--Intrusion-Prevention System 入侵防御系统

IDS--Intrusion Detection System  入侵检测系统

#### 入侵检测技术

产生背景：

- 外部攻击众多
- 内部威胁增多
- 防火墙的局限：只能检测到端口号，或者说只能从网络层面检测
- 各种应用纷杂

发展历程：

![image-20200720100524773](E:\Typora\Image\image-20200720100524773.png)

入侵检测系统分类：

![image-20200720100618553](E:\Typora\Image\image-20200720100618553.png)

离线入侵检测：相当于IDS

在线入侵检测：相当于IPS 

绿盟防护系统演进历史

![image-20200720100717429](E:\Typora\Image\image-20200720100717429.png)

入侵检测流程

数据采集->分析->响应报警

NIPS体系架构

![image-20200720100809277](E:\Typora\Image\image-20200720100809277.png)

检测引擎：

![image-20200720100949667](E:\Typora\Image\image-20200720100949667.png)

![image-20200729104538248](E:\Typora\Image\image-20200729104538248.png)

基于特征匹配举例

在http的get消息头部存在“%2F%2E%2E%2F”字段，相当于是“/../”遍历到上一级目录，被判定为目录遍历漏洞

![image-20200729104811576](E:\Typora\Image\image-20200729104811576.png)

基于统计匹配举例

![image-20200729104834925](E:\Typora\Image\image-20200729104834925.png)





#### IDPS的基本配置

产品实施流程

调研阶段:
·客户拓扑、部署方式
·客户环境，例如是否有MTU大于2048的流量穿过设备

实施步骤:
·基本参数配置:系统时间、账号、DNS、安全中心接口配置
·设备上架
·设备连线
·功能调试:测试网络连通性、测试阻断/告警等

默认用户：

![image-20200720101440142](E:\Typora\Image\image-20200720101440142.png)

注意:

1. admin即为设备管理员，具有最高权限。
2. 实施完毕请告知客户admin和auditor的用户名和密码，并及时修改默认密码。
3. conadmin密码修改视情况而定，一般不修改。(如果修改后忘记，找回这个密码比较麻烦)

Console口登录

波特率115200

web登录：http://IP地址

默认管理口ip:M 192.168.1.1/24 ; H1  192.168.2.1/24

注意：M口和H1口不能配置为同一网段，否则两个接口都无法ping通

###### NIPS基本参数配置

导入证书

注意：

1、初次登录设备会自动提示导入证书

2、及时核查证书有效期、功能模块等是否与客户购买合同一致

3、正式销售证书请及时备份，拷贝给客户存档。如果证书遗失，可以从web页面导出一份

修改系统时间   

注意

1、web界面支持NTP服务器自动同步，也可手动修改系统时间。

2、系统时间直接关系着告警和入侵事件的日志记录时间，请力求设置准确

账号管理

1、默认只启用admin账号，auditor需要手动启用

2、如果忘记密码，请到串口下重置

管理口配置

1、M、H1口为带外管理口，也可做HA心跳口

2、尽量给管理口配置网关，用作跨网段管理、自动升级等

DNS配置

1、自动升级、连接云安全中心必须配置DNS。

2、云端获取信誉库也会用到DNS

升级配置

1、上线前请先升级至最新版本

2、引擎升级会导致设备引擎重启，导致少量丢包，在线升级尽量不要自动升级引擎

3、自动升级事件可以选择其他时间，避免周一00：00的升级高峰

连接安全中心

1、连接安全中心需要配置本地IP地址

2、NIPS可以联动ESPC、云安全中心和BSA

3、连接安全中心并非必须，单独的NIPS也可以正常工作，但因为单位内部存储很小，所以日志不能保存很长时间

产品实施调研表

![image-20200720111347435](E:\Typora\Image\image-20200720111347435.png)

#### NIPS典型拓扑

直通部署

![image-20200720111504646](E:\Typora\Image\image-20200720111504646.png)

数据准备：带外管理口地址和网关地址

配置思路：

1、安全区配置

​	选择“安全->安全区”

​	接口配置

​	应用配置/虚拟线配置

2、虚拟线配置

3、应用配置，使配置生效



#### NIDS典型拓扑

旁路监听部署

![image-20200720141051987](E:\Typora\Image\image-20200720141051987.png)

数据准备:带外管理口地址和网关地址

配置思路：

1、安全区配置

2、接口配置

3、应用配置，使配置生效

监听口不建议配置地址，配置地址会发送和接受一些arp包



上线配置

对于一般用户：

NIPS/NIDS上线时，仅需修改管理口地址及网关，并应用配置，不需进行额外配置

NIPS/NIDS默认出厂时接口安全区为direct或者monitor，以及一条入侵防护策略

NIPS/NIDS默认没有硬盘，日志存储在内存中（最多存储1w条，界面显示1000条)重启后日志会被清空，建议上线时联动ESPC

对于高级用户：除以上配置外，还可以根据需要配置其他策略模块



策略-入侵检测防护

有效识别并阻断网络攻击、蠕虫、和病毒传播

灵活的策略配置：基于安全区、源目的IP/mac、时间等



主要配置步骤：

1. 选择安全区
2. 选择源目的对象
3. 选择规则模板
4. 选择是否启用阻断功能
5. 应用配置，使配置生效

规则模板：

系统规则模板

- 内置模板：按防护的对象进行划分

    内置模板不允许修改任何内容，仅允许查看和派生

    规则数量会随着系统规则库的升级而更新

- 派生模板：由内置模板派生

    派生模板可以修改动作，但不允许再添加规则。

    规则数量会随着系统规则库的升级而更新，但动作与升级前保持一致

用户规则模板：由用户自己选择规则

用户规则模板可以添加或删除规则，也可以修改动作

规则数量和动作都不会随着系统规则库的升级而更新



规则模板使用场景

系统内置模版:
一般用户采用系统内置模版即可，根据可靠度已经选择好需要阻断的规则;并可根据防护的对象选择对应的分类

系统派生模版:
想要额外阻断或者不阻断某条具体规则时，可以派生出一个新的模版，并进行阻断动作的修改

用户规则模版:
可以增加或者减少规则，以及添加自定义规则，适用于更高级的用户

隔离功能

- 启用防护，在一段时间内丢弃触发规则的攻击源IP到目的IP的数据包
- dynamic_isolation_time隔离时间，默认30分钟
- 触发隔离后，在日志中的图标会显示为隔离，而非阻断
- 首页入侵防护告警事件中取消隔离

例外规则

- 针对某个地址对象的某个规则白名单
- 例外规则是全局规则，针对所有链路、所有IP生效
- 添加的例外规则不会产生任何日志和阻断效果
- 查看入侵防护实时监控日志时，可直接添加某条日志规则为例外规则。添加完毕后，应用配置生效
- 也可再对象——规则中，直接添加例外规则

规则查询

- 规则查询位于对象——规则中
- 可使用多种查询条件查询相关规则

#### 入侵防护

###### DoS防护

参数含义：

- 检测阈值:设定的报文阈值
- 检测周期:设定的时间阈值
- 复位时间:每隔设定的时间将统计告警的表项清0，一般不改
- 保护时间:防护的时间。即限流的时间
- 限制流量:开启防护后，允许通过的每秒包的数量。不包括正常通信流中所占的pps，只限制符合告警条件的包

注意事项：

1. 默认阈值较大，在进行测试时要适当调整阈值
2. 一般不建议开启自动保护功能，可能会有误阻断
3. 告警在入侵防护日志中查询

###### 数据泄露防护

数据泄漏防护功能对内网进行有效安全防护，可以防止内网敏感数据的泄露、防止某些文件的外发，可以监控服务器的非法外联行为，以防止攻击者通过服务器进行跳转攻击。

包含三个部分：

1. 敏感数据保护

    敏感数据保护可以防止内部敏感数据（电话、身份证、银行卡）的外泄，在网络流中(HTTP、FTP、EMAIL）发现大量的敏感数据外传时，NGIPS会阻断外传行为，并产生告警日志，启示用户内网存在敏感资源外泄行为

2. 文件识别

    文件识别可以防止内部特定格式的文件的外发，例如在专利局部门中，为了防止专利文档被恶意获取并传到外部，需要监控PDF格式或图片格式文件的外发

3. 服务器异常防护

    服务器异常防护监控服务器的非法外联行为（除服务器合法外联以外的所有外联行为），进而协助网管排查是否有跳转等攻击行为。

    外联----指的是服务器主动向外发起连接

    可以手动设置允许服务器

敏感数据保护-配置

![image-20200720150358112](E:\Typora\Image\image-20200720150358112.png)

敏感数据保护支持的协议和文件类型

![image-20200720150529975](E:\Typora\Image\image-20200720150529975.png)

文件识别--配置

![image-20200720150623978](E:\Typora\Image\image-20200720150623978.png)

服务器异常学习

- 进入【策略】–【数据泄漏防护】–【服务器异常学习】:
- 填写服务器地址和学习时间，然后将学习到的外联IP和端口添加为合法连接

服务器异常防护

- 手工添加网络对象，进行服务器异常防护
- 新建服务器异常防护策略，填写允许的合法连接地址

###### 信誉

信誉防护功能能够防护僵尸网络和恶意站点访问，以及用HTTP、FTP、EMAIL协议传输恶意文件，并产生信誉防护日志

信誉库有两种来源：

1. 云信誉：IPS直接连接绿盟的信誉云（需要IPS配置DNS服务器，并能连接外网），获取到信誉库
2. 企业信誉：IPS连接ESPC，ESPC同时获取到信誉云的信誉库，以及ESPC联动的TAC上报的信誉

信誉防护配置

- 在策略——信誉页面，开启对应的防护类型即可
- 启动僵尸网络防护，手工配置阻断
- 启动web信誉防护，调节游标设置不同信誉值的时间的处理方式

Web信誉---配置白名单

启动web信誉的情况下，可以配置白名单放行部分站点访问

【策略】--【信誉】--【启动web信誉】--【高级选项】

信誉注意事项

- 信誉为全局生效，不区分链路
- 可以到首页的系统版本中看到信誉版本，会不定时更新，每隔24小时更新一次，更新时间随机

高级威胁防护

- 高级威胁防护，指的是NIPS与TAC的联动。
- NIPS将收到的SMTP、POP3、IMAP、HTTP、FTP文件还原，并发送给TAC，TAC检测后将结果返回给lPS，IPS会根据返回进行进行阻断或告警。(FTP协议目前无法阻断)
- TAC产生的信誉优于前面讲的云端信誉，是两个不同
    的信誉库，动作都在“信誉”中配置
- TAC的联动来源分为本地TAC以及云端TAC

高级威胁防护--部署方式

两种部署方式均可，保证IPS与TAC路由可达即可。这两种方式，IPS的G1/3和TAC的G2/1都要设置为管理口，并配成同一网段

![image-20200720153527316](E:\Typora\Image\image-20200720153527316.png)

配置

- 前提配置，登录TAC设备，在【策略】--【协同防御】中新建API账号信息
- 登录IPS设备，进入【策略】--【高级威胁防护】，配置联动TAC地址

![image-20200720153644980](E:\Typora\Image\image-20200720153644980.png)

联动成功后可查联动状态及信誉更新情况

URL分类

- URL分类可以将特定分类的URL进行阻断或告警
- 可以自定义URL分类
- 支持查询URL对应的分类

应用管理

- 有效的识别和管理网络中的各种应用
- 有2000多种应用，可按照多种分类方式进行细粒度的分类
- 可根据特征自定义应用

应用（应用过滤器）和服务是“与”关系

应用与应用过滤器是“或”关系

某一项或两项为空时，为空的这项不参与任何关系

流量管理

1. 配置思路：
2. 配置网络对象
3. 配置时间对象
4. 配置流量通道，设定监控的流量通道。
5. 配置流量策略。
6. 应用配置，使配置生效。

用户管理：可以通过用户管理功能对用户进行认证和识别

用户认证

认证方式有三种：RADIUS、LDAP、本地认证

配置步骤：

- 服务器配置
- 用户认证
- 认证策略

注意事项：

认证功能可以与LDAP服务器、Radius服务器、本地认证联合使用，只有通过了认证，流量才能正常流经设备。同时，日志的告警中，用户字段也会出现IP对应的用户名。

如果想在策略中对用户的选项进行设置，则只能与AD域配合使用，即开启用户识别。同时需要在AD域控上安装ADagent软件

防病毒

POP3接收邮件附件中包含病毒时，即使针对POP3设置了阻断，也不会阻断邮件的接收，而是会将文件中的病毒部分采用空白填充

安全中心配置

NIPS5.6.10只能与ESPCv7联动

点击确定后要点击重启引擎！

还原点：创建出的还原点被保存在设备中，不可下载，重启后依然存在

规则升级注意事项

引擎和规则的关系：

- 当发现不能检测某种攻击或应用时，不光要升级规则库，还要同时升级引擎，才能保证检测的准确性
- 从v5.6.6版本开始，规则库的升级对引擎版本有依赖性

系统配置

远程协助:用于开启ssh，登陆后台(端口50022)。开启该功能会自动重启引擎

时间同步:开启后需要手动重启引擎

除串口外，还支持在界面修改时间

SNMP

组成部分：

- 被管理设备
- SNMP代理
- 网络管理系统（NMS）

![image-20200720162036209](E:\Typora\Image\image-20200720162036209.png)

认证方式：团体名-->用户名+密码

传输类型：Agent、trap

MIB库：系统----备份恢复----备份中下载

中文字符编码方式：中文字符均采用GB2312编码



OID说明

![image-20200720162508273](E:\Typora\Image\image-20200720162508273.png)

![image-20200720162520814](E:\Typora\Image\image-20200720162520814.png)

###### BYPASS

软件bypass：即调试模式，安全引擎不再工作，但疏通引擎仍旧正常工作

DDOS策略仍然生效

硬件BYPASS：bypass的两个端口物理连通，变成一根网线，用户的数据流量可以直接通过设备，不受设备自身当前状态的影响

硬件BYPASS可用条件：

设备带Bypass板卡

- 板载电口支持bypass
- 部分版本和型号支持光板卡BYPASS，V567及以前版本光口BYPASS必须使用外置光BYPASS交换机

经过IPS一路流量经过一对板卡识别的BYPASS口

适用于DIRECT部署

硬件bypass启动条件

- 人工在Web页面设置开启bypass---重启设备生效，bypass灯亮起，网卡灯不亮
- IPS处于掉电状态---bypass灯熄灭，网卡灯熄灭
- IPS系统启动过程---bypass灯亮起，网卡灯熄灭
- 疏通引擎异常---bypass灯亮起，网卡灯熄灭

该手动切换bypass的功能是针对具有内置bypass的接口对而言，不属于设备检测自动切换bypass的范畴，该功能主要是提供给用户，可以手动选择切换当前设备所支持内置bypass的接口对组中的某一组进行切换和回切。

###### 常用参数说明：

- 曰志归并: merger_time，默认3600s

- 检测规避攻击开关: defrag_check(提高对于分片分组攻击的检测)

- 链路状态同步: netcardautolinkdown(需要重启系统生效)(常用于链路聚合流量穿越IPS时)

    ![image-20200720163627894](E:\Typora\Image\image-20200720163627894.png)

- 切换到保密版本: three_powers(可能不满足最新的保密局要求，可以使用专门的涉密升级包切换到保密版本，详见wiki系统中的解决方案4571)

###### CDN追溯源IP

- CDN场景下显示告警真实的源IP，直接在日志分析的源地址中展示
- config.xml中新增开关名字叫“use_cdn_set" , true表示cdn功能打开，false表示cdn功能关闭“
- 在V5.6R10版本中，如果客户流量中采用了CDN场景，但是又没有开启这个参数，则日志中，代理IP的前面会有一个小电脑的图标(V5.6R10以下版本不支持)

###### 串口功能

登陆串口后常用的功能

- 查看/修改接口IP地址
- 修改设备时间
- 恢复系统
- 初始化配置
- 重置web管理员账户(不能解除已经被锁定的IP)

说明：

锁定IP：换IP登录或等待锁定时间结束

锁定账号：重启系统

#### 策略优化

为什么要做策略优化

- 大量的低风险事件、不关注事件、误报事件掩盖了真正的攻击事件。
- 日志分析时，用户无法从大量的告警信息中，找出真正的攻击事件，处理低风险事件浪费大量时间

如何进行策略优化

![image-20200720164419609](E:\Typora\Image\image-20200720164419609.png)

优化---屏蔽不关注的安全事件

找出不关注安全事件

- 统计报表中，生成一段时间的报表，查看其中时间TOP10.
- 注意：策略中不关注时间，需要和用户沟通，确认哪些时间是不需要的

屏蔽不关注事件

创建用户模板或派生模板：

- 将该事件在规则模板中设置为不告警
- 将该事件添加为例外规则

优化---去掉误报

- 若联动ESPC，查看日志报表的入侵防护事件，获取其中的原始报文
- NIPS抓包（(包含触发告警的数据)
- 完整的告警截案/日志
- 根据规则描述简单判断或联系产品支持同事

#### 常见问题处理

##### 紧急情况

如果客户网络十分重要，对断网的时间有严格的要求，一定要以恢复客户网络为优先!

- 如果是直通部署，将设备进入调试模式或直接跳过
- 如果是三层部署，将配置文件和设备运行状态文件导出后，重启设备

##### 非紧急情况

如果客户允许我们先进行排查再恢复网络，则可以按照下页的思路进行排查

![image-20200720165028619](E:\Typora\Image\image-20200720165028619.png)

##### PEAK值

![image-20200720165144159](E:\Typora\Image\image-20200720165144159.png)

诊断工具---回放测试

回访接口只能是monitor口

诊断工具---专家诊断

用于映射设备后台

前提：远程协助已开启，采用portgo小工具远程协助

运行日志：主要记录系统运行过程中的一些状态变化

**延时较大问题排查思路**

如何排查：

1. 查配置，是否有策略阻断了应用，导致必须要重连几次
2. 查丢包，是否性能问题导致了延时较大

如何处理：

1. 修改配置，将规则取消（如果是误报可以提bug)
2. 修改config.xml中的参数，主要是会话超时时间和各种解码

**非对称路由**

![image-20200720165906764](E:\Typora\Image\image-20200720165906764.png)

**高可用性**

拓扑支持:直通主备

切换条件:活动网卡数目/心跳信息

-UP/DOWN端口
-拔插网线
-重启系统
-重启HA

注意事项:正确配置、心跳连接正常

状态
一主机激活状态，从机未激活

**证书常见问题**

导入时提示无效

1. 检查序列号和hash值是否一致
2. 设备系统时间和当前是否一致
3. 申请的证书起始或者截止时间错误。(说明:当前的系统时间要包含在证书的起始——截止时间范围内，系统才能判断证书有效、未过期。)
4. 证书申请错误，例如: hash使用小写申请证书、证书选择的产品版本错误、证书产品种类申请错误
   

**FAQ**

- 出厂时，默认关闭应用识别功能，因此在配置与应用有关的策略时，需要先配置一条应用管理策略
- 禁止热插拔网卡，否则会造成网卡被烧毁!
- 防病毒模块不支持检测rar压缩文件， rar和zip的区别在于，rar需要全下载之后才能进行解压缩，而zip是流模式压缩，下载一点解压一点，因此，rar我们没有进行解压检测
- 识别文件类型时，对于rar文件，也仅能识别到rar，无法识别解压后的文件类型;对于其他流式压缩类型文件，可以识别到解压后的文件类型

新老版本对比

功能模块比较

![image-20200720171002066](E:\Typora\Image\image-20200720171002066.png)

证书过期

![image-20200720171018812](E:\Typora\Image\image-20200720171018812.png)

接口生效方式

![image-20200720171146784](E:\Typora\Image\image-20200720171146784.png)

![image-20200720171205143](E:\Typora\Image\image-20200720171205143.png)

安全中心

![image-20200720171223458](E:\Typora\Image\image-20200720171223458.png)

版本迁移策略

![image-20200720171240162](E:\Typora\Image\image-20200720171240162.png)

固件升级注意事项

![image-20200720171313444](E:\Typora\Image\image-20200720171313444.png)

常见固件版本

![image-20200720171345735](E:\Typora\Image\image-20200720171345735.png)
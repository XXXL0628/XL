# ADS

DDoS和DoS的区别是什么：

Distributed Denial of Service(分布式拒绝服务攻击)

通过大量请求（合法或非法）占用大量网络资源，以达到瘫痪网络的目的

- 堵塞带宽
- 服务器超载
- 阻断用户访问
- 干扰正常业务

DDoS的演化

![image-20200726111814533](E:\Typora\Image\image-20200726111814533.png)

DDoS发展趋势

![image-20200726111910066](E:\Typora\Image\image-20200726111910066.png)

![image-20200726111918354](E:\Typora\Image\image-20200726111918354.png)

#### ADS产品家族

ADS（Anti-DDoS System）----清洗设备

NTA（Network Traffic Analyzer）----检测设备

ADS-M（Management）----集中管理设备

![image-20200726113939063](E:\Typora\Image\image-20200726113939063.png)

绿盟ADS产品家族

![image-20200726115241214](E:\Typora\Image\image-20200726115241214.png)

在售产品外观

![image-20200726115632055](E:\Typora\Image\image-20200726115632055.png)

面板结构

![image-20200726195744178](E:\Typora\Image\image-20200726195744178.png)

- 管理口默认IP地址是**192.168.1.100.**
- web用户名/密码:admin/nsfocus
- 串口用户名/密码:admin/nsfocus
- CLI用户名/密码: routerman/nsfocus(命令手册在知识点2603）
- 电口有内置bypass对，光口一般使用bypass交换机，也有内置bypass板卡



#### ADS常见部署

![image-20200726200132723](E:\Typora\Image\image-20200726200132723.png)

##### 串联部署

为什么选择串联？

- 客户网络不支持旁路部署，只能选择串联部署
- ADS型号低，只支持串联部署

缺点：**不防护回去的流量**

![image-20200726200328984](E:\Typora\Image\image-20200726200328984.png)

部署基本过程：

- 配置管理口IP地址并连线，确保网络可达，管理员PC可以登录ADS WEB页面
- 确定被保护IP链路方向
- 确定互联网链路方向
- ADS OUT口连接被保护IP链路方向
- ADS IN口连接互联网链路方向
- 查看路由交换设备及ADS的接口是否协商正确，接口是否UP

常见问题

IN/OUT口接反会怎样?

- 只防护IN口进来的流量，不防护OUT位进来的流量

IN/OUT口接反怎样判断?

- 如果接反了，对服务器来讲，一般流量是进来少，出去多，可以大概判断;更准确的方法可以抓包判断

不配置IN/OUT口默认是通的吗?

- 客户端和服务器的链路必须配置在同一通道中;不在通道中、配置在不同的通道中，客户端和服务器都无法ping通。



##### 单台旁路（自动牵引）

NTA与ADS联动部署（自动牵引）

![image-20200726201212612](E:\Typora\Image\image-20200726201212612.png)

##### 单台旁路（手工牵引）

![image-20200726201254645](E:\Typora\Image\image-20200726201254645.png)

旁路-牵引和回注方式

![image-20200726201352452](E:\Typora\Image\image-20200726201352452.png)

部署过程

- 为ADS管理口配置IP地址并连线，确保网络可达，管理员PC可以登录ADS WEB页面
- 选择相应的牵引与回注方式
- 确定ADS牵引接口及回注接口。
- 与ADS接口对应，确定路由交换设备端的牵引接口与回注接口
- 与客户获取一个测试服务器IP地址，用于验证牵引与回注过程。
- 配置牵引，确认测试IP流量可牵引到ADS
- 配置回注，确认牵引到ADS的流量可以正常回注到测试IP

准备工作

- 管理口IP地址使用默认的192.168.1.100
- 牵引方式:BGP牵引
- 回注方式:策略路由(PBR）回注
- ADS牵引口和回注口都是G2/1
- 对端路由器牵引口和回注口都是0/0/20
- 测试服务器IP是40.40.40.1

BGP牵引

- 动态路由协议
- 分EGP和IGP，唯一的在AS之间传递路由信息的协议，ADS用的是EGP
- 报文类型由：Open、Update、KeepAlive、Notification

![image-20200726201922165](E:\Typora\Image\image-20200726201922165.png)

选路原则：

1. 最长掩码匹配
2. 路由管理距离（AD/优先级）
3. 路由开销（Metric）

![image-20200726202035505](E:\Typora\Image\image-20200726202035505.png)

![image-20200726202042788](E:\Typora\Image\image-20200726202042788.png)

BGP牵引原理：

- 对端路由器建立ebgp邻居
- 向对端路由器发送关于被保护ip的路由更新
- 确保路由器上关于被保护目的ip最优的路由（32位掩码、ebgp路由优先级高）



路由器的BGP配置

![image-20200726202317030](E:\Typora\Image\image-20200726202317030.png)

##### ADS配置

BGP deamon配置

![image-20200726202640415](E:\Typora\Image\image-20200726202640415.png)

BGP邻居配置

![image-20200726202700882](E:\Typora\Image\image-20200726202700882.png)

“应用”和“保存”

- 应用：策略生效，重启后失效
- 保存：策略写入固件，重启后仍然保存

路由器NGP邻居检查

![image-20200726203030492](E:\Typora\Image\image-20200726203030492.png)

ADS BGP检查

![image-20200726204115926](E:\Typora\Image\image-20200726204115926.png)



手工流量牵引

- IP地址：40.40.40.1 //被保护IP
- 子网掩码：255.255.255.255 //最长掩码
- 牵引目的：127.0.0.1  //表示往ADS上进行牵引
- 路由deamon：testbgp  //选择刚才建立的BGP deamon
- 规则状态：启用

![image-20200726204322553](E:\Typora\Image\image-20200726204322553.png)



### 注入

#### PBR注入

##### 策略路由注入（三层注入）

![image-20200726204446724](E:\Typora\Image\image-20200726204446724.png)

思科：PBR配置

![image-20200726204541497](E:\Typora\Image\image-20200726204541497.png)接口配置

![image-20200726204613152](E:\Typora\Image\image-20200726204613152.png)

ADS配置

诸如接口、注入路由，配置后保存

注入验证：

牵引前，从Client端 Trace

![image-20200726204755505](E:\Typora\Image\image-20200726204755505.png)

牵引后，从Client 端 Trace

![image-20200726204805955](E:\Typora\Image\image-20200726204805955.png)



#### 二层注入

![image-20200726204945975](E:\Typora\Image\image-20200726204945975.png)

二层注入特点：

- 注入时ADS会主动学习服务器的MAC地址用于注入;
- ADS的注入接口必须与服务器同VLAN;
- 必须为ADS的注入接口分配一个空闲的、与服务器同网段的IP地址;

选择二层注入方式的情况：

- 某些情况下，无法使用跨接、策略路由等注入方式；
- 必须使用二层注入：被保护IP、ADS均连接在统一交换机上，此时必须使用二层注入

二层交换机配置：

![image-20200726205310664](E:\Typora\Image\image-20200726205310664.png)

ADS配置

- 注入接口：打标不打标，VLAN ID的配置方法
- 注入路由：下一跳没有地址写全0



二层回注：

注入验证：

- 查看ADS的MAC地址表，确认有服务器的MAC
- 客户端PING验证
- 能ping通服务器IP



#### GRE注入

![image-20200726205641642](E:\Typora\Image\image-20200726205641642.png)

#### MPLS注入

![image-20200726205705248](E:\Typora\Image\image-20200726205705248.png)

- ADS只能学习标签，按照学到TAG的打标
- 具体配置查看wiki知识点1017



常见问题：

BGP邻居无法建立：ADS和对端路由器无法正常建立bgp邻居

![image-20200726205824307](E:\Typora\Image\image-20200726205824307.png)

路由器侧注意：

路由器给ADS发太多路由更新，ADS会给路由器回复notification，导致BGP邻居中断

旁路-牵引&注入关系

- 牵引和注入的过程是分离的

注入不成功无法进行牵引

- 如果注入有问题，牵引过来不能正常注入，流量会断，所以后来界面做了限制

**注入失败解决办法**

(1）看注入接口是否配置正确;

(2）注入路由是否配置正确（依据采用的注入方法而定);

(3）注入是否出现环路，PBR是否生效;

(4）若以上均正确，查看MAC地址表，是否学到正确的ads下一跳的mac地址，如果表项多可以查询。二层注入，是否学到了server mac；若没学到，或学到错误mac肯定注入不通;错误mac处理:手动删除，再添加正确的mac

(5）通过在ADS上抓发送的包、或者端口镜像看注入的包，看包是否发出，MAC地址等封包是否正确。

PBR回注中，策略路由没有生效会出现什么情况：

- 出现环路，数据无法往下传输

出环现象？

- ADS上牵引回注已经成功，但是client无法ping通server；
- 在ADS上抓包查看包TTL，发现TTL不断减小；
- Client trace 到达ADS流量不再往下转发

出现环路怎么办？

1. 检查PBR配置，next-hop问题
2. 是否应用到了正确的接口上
3. 方向是否正确





## ADS攻防

ADS算法工作思路

![image-20200726210957674](E:\Typora\Image\image-20200726210957674.png)

信任：

- 通过syn-cookie-url算法验证，加入高级信任
- 通过其它算法验证，加入普通信任
- 源IP加入信任
- 信任时间过，需要再次通过算法

#### SYN-FLOOD攻击

![image-20200726211248595](E:\Typora\Image\image-20200726211248595.png)

- 服务器收到SYN报文，给客户分配必要的资源
- 短时间内出现大量的SYN报文，但没有ACK报文，服务器最终因为资源耗尽而瘫痪

判断SYN攻击

- 协议特征：一般都是TCP协议
- 源IP：很杂，不固定一个
- 目的IP：只有一个
- 发包速率：很快

符合以上特征的基本可以确定是SYN攻击



SYN算法1

![image-20200726211743375](E:\Typora\Image\image-20200726211743375.png)

SYN算法2

![image-20200726211855937](E:\Typora\Image\image-20200726211855937.png)



专业数据1∶防护阈值
专业数据2:反向探测包速率总和
启用防护:开启防护的开关（以前叫双向防护)



#### ACK-FLOOD攻击

服务器收到ACK包的正常处理流程：

![image-20200726212601473](E:\Typora\Image\image-20200726212601473.png)

攻击原理：

- 大量的ACK包消耗服务器资源、阻塞带宽
- 组合攻击，增强攻击效果

ACK-Flood普通算法

![image-20200726212905605](E:\Typora\Image\image-20200726212905605.png)

说明：

ACK高级算法

TCP报文除了SYN都算ACK，例如push+ACK，FIN+ACK，RST



#### UDP-FLOOD

正常UDP：无连接、无状态的传输协议

攻击流量：

- 目标端口有UDP应用，干扰正常应用
- 目标端口无UDP应用，回送ICMP，消耗资源

![image-20200726213204194](E:\Typora\Image\image-20200726213204194.png)

#### ICMP-FLOOD

ICMP：

- Internet Control Message Protocol
- Internet控制报文协议
- 属于IP层报文

ICMP-FLOOD：发送大量的ICMP报文（ping包）

说明：

- 老版本:超过阈值，会封禁所有icmp包和ip分片包(所有非TCP/UDP协议报文+分配的TCP/UDP报文)
- 新版本:限制ICMP/ICMPv6的非分片报文源/目的IP流量，分片报文选择丢弃或放行

#### DNS-FLOOD

Domain Name System 域名系统

![image-20200726213546832](E:\Typora\Image\image-20200726213546832.png)

攻击类型：

- 阻塞宽带：发送海量的DNS查询报文
- 资源消耗：发送大量非法域名查询报文引起持续性迭代（递归查询）

![image-20200726213726371](E:\Typora\Image\image-20200726213726371.png)

DNS算法1：针对目的端口 53的UDP算法

DNS算法2：

![image-20200726213915779](E:\Typora\Image\image-20200726213915779.png)

说明：

- DNS算法的阈值都是UDP FLOOD专业数据1
- 有单独的反向探测速率控制

#### WEB攻击类型

1. HTTP GET/POST FLOOD
    - 纯HTTP GET/POST，建立完三次握手发GET/POST请求，肉鸡攻击
2. 慢速攻击、空连接
    - 只建立三次握手，但不发送GET/POST
    - 建立三次握手，发送特殊的GET/POST
    - 如：一个GET/POST请求拆成2个或者多个，如slowloris、pyloris
3. 代理型
    - 通过代理访问web server，报文源ip都为代理server，x-forward，via，proxy字段

HTTP FLOOD防御算法

![image-20200727092555458](E:\Typora\Image\image-20200727092555458.png)

URL验证算法实例

![image-20200727092630892](E:\Typora\Image\image-20200727092630892.png)

cc攻击

- ChallengeCollapsar

- 网站攻击方法，攻击者通过代理服务器或者肉鸡向受害主机发送大量数据包，造成服务器资源耗尽

- 图片验证算法

    ![image-20200727092828596](E:\Typora\Image\image-20200727092828596.png)

其他防护方法：

- 代理防护：ADS前面是否有CDN？
- POST防护
- 慢速攻击防护
- URL-ACL防护

黑白名单

加入白名单跟源IP加入信任有什么区别？

- 白名单永久生效，信任有时间期限需要重复验证

连接耗尽防护

- 触发规则：加入黑名单；如果黑名单未启用，无防护效果

- 不建议开启

- 原因：

    - 防护逻辑中没有会话表
    - 误报率较高

    

    

模式匹配

分析数据包特征

![image-20200727093527157](E:\Typora\Image\image-20200727093527157.png)

流量清洗顺序

![image-20200727093544090](E:\Typora\Image\image-20200727093544090.png)

上线配置流程-收集业务信息

![image-20200727093643473](E:\Typora\Image\image-20200727093643473.png)

建立防护群组

针对性防护：

- 不同业务类型
- 不同的防御策略
- 服务器性能不同

防护阈值的确定

- 专业数据1:触发防护算法的阈值(pps)
- 专业数据2∶反向探测的最大能力，包括SYN-FLood、DNS-FLood探测（默认)
- 阈值需高于流量峰值
- 攻击很容易触发阈值，因此阈值不宜设低，通常建议1.5倍于峰值，或者服务器承受性能的80%
- 考虑客户的业务类型
- 带宽、服务器性能

缺省参数VS防护群组

- 若配置了群组策略，此IP不受缺省策略影响;
- “选择”:勾选表示此类防护使用群组策略，否则使用缺省策略;
- “启用防护”:群组内此策略的开关;
- 防御时可牵引某一个群组;
- 若需要时可以调整缺省参数:级别必须选摔professional



攻防实战

![image-20200727094327268](E:\Typora\Image\image-20200727094327268.png)

1. ADS接收到的流量=所有牵引口RX之和
2. ADS转发给被保护侧网络的流量=所有回注口TX之和
3. ADS清洗了多少流量？
    - ADS清洗的攻击流量=IN口RX-OUT口TX
    - ADS清洗的攻击流量=牵引口RX-回注口TX
4. 判断业务是否正常，不依赖此图，依赖业务监控

告警日志

- 30s随机出3条
- 保留15天
- 重启后丢失所有日志
- 告警类型、特征（藏经阁下载文档，右上角帮助信息）



![image-20200727095134278](E:\Typora\Image\image-20200727095134278.png)

1. 接收：攻击来时，抓取到的大部分为攻击包，攻击源是肉鸡或是发包机
2. 发送：ADS认为是正常流量的包、反向探测包
3. 丢弃：ADS认为是攻击的包

注意：重启后抓包也会丢失



验证效果

- 自己验证：

    - 业务恢复

    - ADS抓发送包，都是正常流量

- 客户反馈业务恢复



常见问题

升级

- 软件版本:
    - 百兆设备:V4.5R10
    - 千兆和万兆设备:V4.5R89
    - ADS升级要求严格，请严格按照型号、升级路线来进行，具体参照解决方案3771
- 注意事项
    - 提示成功后，手动在界面远程重启
    - 升级完成后不用点“保存”
    - 重启后版本才会更新

升级前准备工作

- 建议重启ADS
- 写固件，必要时截图保存配置
- 停止牵引
- 明确升级顺序，认真阅读升级说明并按不受操作
- 校验MD5值



关于ADS证书

- 正式证书过期后，设备功能不受任何影响，但不能升级版本
- 试用证书过期后，设备会自动进入包转发状态（所有防护失效)，也不能升级，但界面可以正常访问
- 运行模式只有串联和集群defender(旁路）两种，其他类型都不合法
- 证书导入后可重启设备立即生效，或等待4小时自动生效
- 导入证书时间要在新证书的起始日期和终止日期之间
- 证书制作的设备型号、序列号要跟设备实际情况相符
- 更多参见解决方案5735......



串口常用操作

![image-20200727100106819](E:\Typora\Image\image-20200727100106819.png)

1. 设置ipv4的管理口ip和网关ip设置
2. 设置ipv6的管理口ip和网关ip设置;
3. 设置dns服务器地址;
4. 更改串口密码;
5. 设置系统时间;
6. 恢复管理口IP和登陆密码;
7. 恢复web登录账号admin的默认密码;
8. 串口登录无响应超时设置;
9. 上一版本回退，只能回退一次;
10. 退出;